name: Release Asset Finalizer

on:
  workflow_run:
    workflows:
      - CI Build
    types:
      - completed

permissions:
  contents: write
  actions: read

jobs:
  attach-assets:
    if: github.event.workflow_run.event == 'workflow_dispatch' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Resolve release tag for build SHA
        id: resolve
        env:
          BUILD_SHA: ${{ github.event.workflow_run.head_sha }}
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          git fetch --force --tags origin

          mapfile -t tags < <(
            git tag --points-at "${BUILD_SHA}" \
              | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$' \
              | sort -V
          )

          if [ "${#tags[@]}" -eq 0 ]; then
            echo "No release tag found for ${BUILD_SHA}; this is likely a regular manual build. Skipping."
            echo "should_attach=false" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          tag="${tags[-1]}"
          if ! gh release view "${tag}" --repo "${GITHUB_REPOSITORY}" >/dev/null 2>&1; then
            echo "Tag ${tag} exists but no GitHub release found. Skipping."
            echo "should_attach=false" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          echo "Resolved release tag ${tag} for ${BUILD_SHA}."
          echo "should_attach=true" >> "${GITHUB_OUTPUT}"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"

      - name: Download build artifacts
        if: steps.resolve.outputs.should_attach == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          BUILD_RUN_ID: ${{ github.event.workflow_run.id }}
          BUILD_SHA: ${{ github.event.workflow_run.head_sha }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-artifacts
          gh run download "${BUILD_RUN_ID}" \
            --repo "${GITHUB_REPOSITORY}" \
            --dir release-artifacts \
            --pattern "jars-*-${BUILD_SHA}"

      - name: Upload jars to draft release
        if: steps.resolve.outputs.should_attach == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.resolve.outputs.tag }}
        shell: bash
        run: |
          set -euo pipefail
          find release-artifacts -type f -name "*.jar" | sort -u > release_assets.txt
          if [ ! -s release_assets.txt ]; then
            echo "No jar assets found in artifacts for ${TAG}."
            exit 1
          fi

          mapfile -t assets < release_assets.txt
          gh release upload "${TAG}" \
            --repo "${GITHUB_REPOSITORY}" \
            --clobber \
            "${assets[@]}"

          echo "Uploaded ${#assets[@]} jar assets to ${TAG}."
