name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (semver), e.g. 0.0.1"
        required: true
        type: string
      release_name:
        description: "GitHub release title"
        required: true
        type: string
      release_notes:
        description: "Optional short intro note (prepended to auto-generated notes)"
        required: false
        type: string
      prerelease:
        description: "Mark this release as prerelease"
        required: true
        default: false
        type: boolean

permissions:
  contents: write
  actions: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Guard main branch only
        run: |
          if [ "${GITHUB_REF}" != "refs/heads/main" ]; then
            echo "This workflow can be run only from main. Current ref: ${GITHUB_REF}"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Validate release inputs
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          if ! [[ "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid version '${VERSION}'. Expected semver, e.g. 0.0.1 or 0.0.1-rc.1"
            exit 1
          fi
          TAG="v${VERSION}"
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} already exists locally."
            exit 1
          fi
          if git ls-remote --tags origin "${TAG}" | grep -q "${TAG}$"; then
            echo "Tag ${TAG} already exists on origin."
            exit 1
          fi

      - name: Bump version in gradle.properties
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          sed -i "s/^mod.version=.*/mod.version=${VERSION}/" gradle.properties
          if git diff --quiet -- gradle.properties; then
            echo "mod.version is already ${VERSION}; release bump must change gradle.properties."
            exit 1
          fi

      - name: Commit and tag release
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          TAG="v${VERSION}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add gradle.properties
          git commit -m "chore(release): ${TAG}"
          git tag "${TAG}"
          git push origin HEAD:main
          git push origin "${TAG}"

      - name: Trigger full CI Build for release commit
        id: trigger_ci
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          RELEASE_SHA="$(git rev-parse HEAD)"
          TRIGGERED_AT="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "release_sha=${RELEASE_SHA}" >> "$GITHUB_OUTPUT"
          echo "triggered_at=${TRIGGERED_AT}" >> "$GITHUB_OUTPUT"

          gh workflow run build.yml \
            --repo "${GITHUB_REPOSITORY}" \
            --ref main

          echo "Triggered full CI Build workflow_dispatch for commit ${RELEASE_SHA}."

      - name: Wait for triggered CI Build to finish
        id: wait_ci
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_SHA: ${{ steps.trigger_ci.outputs.release_sha }}
          TRIGGERED_AT: ${{ steps.trigger_ci.outputs.triggered_at }}
        run: |
          set -euo pipefail
          echo "Waiting for triggered CI Build workflow for commit ${RELEASE_SHA}..."
          RUN_ID=""
          for _ in $(seq 1 120); do
            RUN_ID="$(gh run list \
              --repo "${GITHUB_REPOSITORY}" \
              --workflow build.yml \
              --branch main \
              --event workflow_dispatch \
              --json databaseId,headSha,status,conclusion,createdAt \
              --limit 50 \
              --jq ".[] | select(.headSha == \"${RELEASE_SHA}\" and .createdAt >= \"${TRIGGERED_AT}\") | .databaseId" \
              | head -n1 || true)"

            if [ -n "${RUN_ID}" ]; then
              STATUS="$(gh run view "${RUN_ID}" --repo "${GITHUB_REPOSITORY}" --json status --jq '.status')"
              CONCLUSION="$(gh run view "${RUN_ID}" --repo "${GITHUB_REPOSITORY}" --json conclusion --jq '.conclusion // \"\"')"
              echo "CI Build run ${RUN_ID}: status=${STATUS} conclusion=${CONCLUSION}"

              if [ "${STATUS}" = "completed" ]; then
                if [ "${CONCLUSION}" = "success" ]; then
                  echo "release_sha=${RELEASE_SHA}" >> "$GITHUB_OUTPUT"
                  echo "run_id=${RUN_ID}" >> "$GITHUB_OUTPUT"
                  exit 0
                fi
                echo "CI Build failed for ${RELEASE_SHA} (conclusion: ${CONCLUSION})."
                exit 1
              fi
            else
              echo "CI Build run for ${RELEASE_SHA} not visible yet."
            fi

            sleep 30
          done

          echo "Timed out waiting for CI Build on ${RELEASE_SHA}."
          exit 1

      - name: Download release artifacts from CI
        env:
          GH_TOKEN: ${{ github.token }}
          CI_RUN_ID: ${{ steps.wait_ci.outputs.run_id }}
          RELEASE_SHA: ${{ steps.wait_ci.outputs.release_sha }}
        run: |
          set -euo pipefail
          mkdir -p release-artifacts
          gh run download "${CI_RUN_ID}" \
            --repo "${GITHUB_REPOSITORY}" \
            --dir release-artifacts \
            --pattern "jars-*-${RELEASE_SHA}"

      - name: Prepare release assets
        run: |
          set -euo pipefail
          find release-artifacts -type f -name "*.jar" | sort -u > release_assets.txt
          if [ ! -s release_assets.txt ]; then
            echo "No jar assets found."
            exit 1
          fi
          echo "Assets to upload:"
          cat release_assets.txt

      - name: Create draft GitHub release with jar assets
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ inputs.version }}
          RELEASE_NAME: ${{ inputs.release_name }}
          RELEASE_NOTES: ${{ inputs.release_notes }}
          PRERELEASE: ${{ inputs.prerelease }}
        run: |
          set -euo pipefail
          TAG="v${VERSION}"
          ARGS=()
          if [ "${PRERELEASE}" = "true" ]; then
            ARGS+=(--prerelease)
          fi
          ARGS+=(--generate-notes)
          if [ -n "${RELEASE_NOTES}" ]; then
            printf "%s\n" "${RELEASE_NOTES}" > release_notes.md
            ARGS+=(--notes-file release_notes.md)
          fi
          mapfile -t ASSETS < release_assets.txt
          gh release create "${TAG}" \
            --repo "${GITHUB_REPOSITORY}" \
            --draft \
            --title "${RELEASE_NAME}" \
            "${ARGS[@]}" \
            "${ASSETS[@]}"
