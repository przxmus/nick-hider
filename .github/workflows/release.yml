name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (semver), e.g. 0.0.1"
        required: true
        type: string
      release_name:
        description: "GitHub release title"
        required: true
        type: string
      release_notes:
        description: "Optional short intro note (prepended to auto-generated notes)"
        required: false
        type: string
      prerelease:
        description: "Mark this release as prerelease"
        required: true
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Guard main branch only
        run: |
          if [ "${GITHUB_REF}" != "refs/heads/main" ]; then
            echo "This workflow can be run only from main. Current ref: ${GITHUB_REF}"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Validate release inputs
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          if ! [[ "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid version '${VERSION}'. Expected semver, e.g. 0.0.1 or 0.0.1-rc.1"
            exit 1
          fi
          TAG="v${VERSION}"
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} already exists locally."
            exit 1
          fi
          if git ls-remote --tags origin "${TAG}" | grep -q "${TAG}$"; then
            echo "Tag ${TAG} already exists on origin."
            exit 1
          fi

      - name: Bump version in gradle.properties
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          sed -i "s/^mod.version=.*/mod.version=${VERSION}/" gradle.properties
          if git diff --quiet -- gradle.properties; then
            echo "mod.version is already ${VERSION}; release bump must change gradle.properties."
            exit 1
          fi

      - name: Commit and tag release
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          TAG="v${VERSION}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add gradle.properties
          git commit -m "chore(release): ${TAG}"
          git tag "${TAG}"
          git push origin HEAD:main
          git push origin "${TAG}"

      - name: Build all release artifacts
        run: |
          set -euo pipefail
          ./gradlew --no-daemon clean build

      - name: Collect release jars
        run: |
          set -euo pipefail
          mkdir -p release-artifacts

          mapfile -t jars < <(
            find . -type f -path "*/build/libs/*.jar" \
              ! -name "*-sources.jar" \
              ! -name "*-javadoc.jar" \
              ! -name "*-dev.jar" \
              ! -name "*-shadow.jar" \
              | sort -u
          )

          if [ "${#jars[@]}" -eq 0 ]; then
            echo "No release jars found after build."
            exit 1
          fi

          for jar in "${jars[@]}"; do
            cp "${jar}" "release-artifacts/$(basename "${jar}")"
          done

          mapfile -t unique_jars < <(find release-artifacts -type f -name "*.jar" | sort -u)
          if [ "${#unique_jars[@]}" -eq 0 ]; then
            echo "No unique jars in release-artifacts."
            exit 1
          fi

          printf '%s\n' "${unique_jars[@]}" > release_assets.txt

      - name: Create GitHub release and upload assets
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ inputs.version }}
          RELEASE_NAME: ${{ inputs.release_name }}
          RELEASE_NOTES: ${{ inputs.release_notes }}
          PRERELEASE: ${{ inputs.prerelease }}
        run: |
          set -euo pipefail
          TAG="v${VERSION}"

          ARGS=()
          if [ "${PRERELEASE}" = "true" ]; then
            ARGS+=(--prerelease)
          fi
          ARGS+=(--generate-notes)

          if [ -n "${RELEASE_NOTES}" ]; then
            printf "%s\n" "${RELEASE_NOTES}" > release_notes.md
            ARGS+=(--notes-file release_notes.md)
          fi

          mapfile -t assets < release_assets.txt

          gh release create "${TAG}" \
            --repo "${GITHUB_REPOSITORY}" \
            --title "${RELEASE_NAME}" \
            "${ARGS[@]}" \
            "${assets[@]}"

      - name: Print release summary
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          TAG="v${VERSION}"
          asset_count="$(wc -l < release_assets.txt | tr -d '[:space:]')"

          echo "Release ${TAG} created with ${asset_count} assets."

          {
            echo "## Manual Release Summary"
            echo
            echo "- Tag: \`${TAG}\`"
            echo "- Release name: \`${{ inputs.release_name }}\`"
            echo "- Prerelease: \`${{ inputs.prerelease }}\`"
            echo "- Uploaded jar assets: \`${asset_count}\`"
          } >> "${GITHUB_STEP_SUMMARY}"
